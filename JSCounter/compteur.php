<?php	// Adresse ip du visiteur	if($_SERVER) 	{				if(isset($_SERVER['HTTP_X_FORWARDED_FOR']))						$adress = $_SERVER['HTTP_X_FORWARDED_FOR'];					elseif(isset($_SERVER['HTTP_CLIENT_IP']))						$adress = $_SERVER['HTTP_CLIENT_IP'];					else						$adress = $_SERVER['REMOTE_ADDR'];			}	 else 		{					if(getenv('HTTP_X_FORWARDED_FOR'))						$adress = getenv('HTTP_X_FORWARDED_FOR');					elseif(getenv('HTTP_CLIENT_IP'))						$adress = getenv('HTTP_CLIENT_IP');					else						$adress = getenv('REMOTE_ADDR');			}				$jour = date("Y-m-d");// Date du jour	$mois = date("m");// Mois	$moins=1286143200; // Timestamp correspondant au 04/10/2010(mise en ligne du site)	$heure=time()-$moins; // Heure	require 'config.php'; // On prend les infos de la config.	$connexion = @mysql_connect(DB_HOST,DB_LOGIN,DB_PASS);// Connexion à la base	if(!$connexion)	{		print "<p align=center><font face=verdana size=4><b>...</b></font></p>"; //Message d'erreur.		exit();	}	else	{ // Si connexion est bonne		mysql_select_db(DB_BDD,$connexion); //Selection de la base		//On récupére les données		$sql="SELECT * FROM ". DB_TABLE_COMPTEUR ." WHERE ip='compt1'";		$res=mysql_query($sql, $connexion);		$inf1 = mysql_fetch_object ($res);		$compt_j=$inf1->compt_j;//compteur jour		$compt_ms=$inf1->visite;//compteur mensuel		$compteur=$inf1->duree;//compteur total				$refer= explode("@",$inf1->refs);//on récupère le temps de visite et la durée de connexion				//Durées pour supression des ip.		$t_ref=$refer[1];		$t_ref=$t_ref*3600;		$datesup=$heure-$t_ref;				//Durée de connexion d'un utilisateur.		$d_ref=$refer[2];		$d_ref=$d_ref*60;		$durée_cnt=$heure-$d_ref;		//Suppression des adresses ip plus vielle que le temps de réferences (24h par défault).		$sql="delete from ". DB_TABLE_COMPTEUR ." where ip!='compt1' and visite<=$datesup ";		$res=mysql_query($sql, $connexion) or die ("1"); // 1 : requete invalide del ip		 		if ($jour!="$inf1->date")//Si on a changé de jour.		{					$sql="update ". DB_TABLE_COMPTEUR ." set date='$jour' WHERE ip='compt1'";//On met a jour la date actuelle dans la table.					$res=mysql_query($sql, $connexion) or die ("2"); // 2 : requete invalide maj date								// Remise à 0 du compteur jour.				$compt_j=0; 				$sql="update ". DB_TABLE_COMPTEUR ." set compt_j=0 WHERE ip='compt1'";				$res=mysql_query($sql, $connexion) or die ("3"); //3 : requete invalide maj date								if ($mois!=substr($inf1->date,5,2))//Si on a changé de mois.				{					// Remise à 0 du compteur mois.					$compt_ms=0;					$sql="update ". DB_TABLE_COMPTEUR ." set visite=0 WHERE ip='compt1'";					$res=mysql_query($sql, $connexion) or die ("4"); //4 : requete invalide maj date					$sql2="OPTIMIZE TABLE ". DB_TABLE_COMPTEUR ."";//optimisation de la table					$res2=mysql_query($sql2, $connexion) or die ("5"); //5 : requete invalide optimize table				}		}				//On verifie si l'IP du visiteur et connue		$sql="select ip from ". DB_TABLE_COMPTEUR ." where ip='$adress'";		$res=mysql_query($sql, $connexion) or die ("6"); //6 : requete invalide verif ip		$num_rows =mysql_numrows ($res);				if ($num_rows==0)		{			// Adresse ip inconnue, on l'enregistre et on incremente les compteurs.			$sql="insert into ". DB_TABLE_COMPTEUR ." (ip,visite,duree,date) values ('$adress','$heure','$heure','$jour')";			$res=mysql_query($sql, $connexion)or die ("7");// 7 : requete invalide enr ip			$compt_j+=1;			$compt_ms+=1;			$compteur+=1;			$sql="update ". DB_TABLE_COMPTEUR ." set visite=$compt_ms, duree=$compteur, compt_j=$compt_j where ip='compt1'";			$res=mysql_query($sql, $connexion) or die ("8");//8 : requete invalide up compteur M et G		}				else		{			//Adresse ip connue on met à jour la durée.			$sql="update ". DB_TABLE_COMPTEUR ." set duree=$heure where ip='$adress'";			$res=mysql_query($sql, $connexion) or die ("9");// 9 : requete invalide maj duree		}		// Calcul du nombre de connectés		$sql="select duree from ". DB_TABLE_COMPTEUR ." where duree>='$durée_cnt'";		$res=mysql_query($sql, $connexion) or die ("10");// 10 : requete invalide verif ip		$num_rows =mysql_numrows ($res);		$compt_c=$num_rows;	}	//On ferme la connexion.	@mysql_close($connexion);				($compt_c ==1 )? $plur_v="" : $plur_v="s";//"s" si plusieurs connectés	?>